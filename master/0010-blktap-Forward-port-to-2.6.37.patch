From bf926e6a798de7677d0fb0250d41ac850d7a848c Mon Sep 17 00:00:00 2001
From: Daniel Stodden <daniel.stodden@citrix.com>
Date: Tue, 15 Mar 2011 04:17:29 -0700
Subject: [PATCH 10/11] blktap: Forward port to 2.6.37

 - Use blk_queue_flush to set up cache flushes.

Signed-off-by: Daniel Stodden <daniel.stodden@citrix.com>
---
 drivers/block/blktap/device.c |    8 +++-----
 1 files changed, 3 insertions(+), 5 deletions(-)

diff --git a/drivers/block/blktap/device.c b/drivers/block/blktap/device.c
index 537673e6..3f7e8aa 100644
--- a/drivers/block/blktap/device.c
+++ b/drivers/block/blktap/device.c
@@ -319,9 +319,7 @@ blktap_device_configure(struct blktap *tap,
 
 	/* Enable cache control */
 	if (info->flags & BLKTAP_DEVICE_FLAG_FLUSH)
-		blk_queue_ordered(rq, QUEUE_ORDERED_DRAIN_FLUSH);
-	else
-		blk_queue_ordered(rq, QUEUE_ORDERED_DRAIN);
+		blk_queue_flush(rq, REQ_FLUSH);
 
 	/* Block discards */
 	if (info->flags & BLKTAP_DEVICE_FLAG_TRIM) {
@@ -540,14 +538,14 @@ blktap_device_create(struct blktap *tap, struct blktap_device_info *info)
 
 	dev_info(disk_to_dev(gd),
 		 "sector-size: %u/%u+%u capacity: %llu"
-		 " discard: %u+%u ordered: %#x\n",
+		 " discard: %u+%u flush: %#x\n",
 		 queue_logical_block_size(rq),
 		 queue_physical_block_size(rq),
 		 queue_alignment_offset(rq),
 		 (unsigned long long)get_capacity(gd),
 		 rq->limits.discard_granularity,
 		 queue_discard_alignment(rq),
-		 rq->ordered);
+		 rq->flush_flags);
 
 	return 0;
 
-- 
1.7.4.1

