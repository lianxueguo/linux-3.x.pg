Convert to GIT

From: Frediano Ziglio <frediano.ziglio@citrix.com>

Use GIT macros instead of HG ones

diff --git a/mk/Makefile b/mk/Makefile
new file mode 100644
index 0000000..7afc26b
--- /dev/null
+++ b/mk/Makefile
@@ -0,0 +1,124 @@
+USE_BRANDING := yes
+IMPORT_BRANDING := yes
+REPONAME=linux-3.x
+include /b/common.mk
+include /b/rpmbuild.mk
+
+RPM_BUILT_COOKIE  = $(MY_OBJ_DIR)/.pvops_rpm_built_cookie
+FILES_COOKIE      = $(MY_OBJ_DIR)/.files.cookie
+REPO              = $(call git_loc,$(REPONAME))
+REPOSTAMP         = $(call git_req,$(REPONAME))
+
+-include $(MY_OBJ_DIR)/pvops_version.inc
+$(MY_OBJ_DIR)/pvops_version.inc: $(REPOSTAMP)
+	$(call version-makefile) > $@
+	awk -F. '{ print "REPO_VERSION=" $$0; }' \
+		< $(REPOSTAMP) >> $@
+	awk '/(^VERSION)|(^PATCHLEVEL)|(^SUBLEVEL)|(^EXTRAVERSION)/ { print "KERNEL_"$$_ }' ../Makefile >> $@
+	echo LINUX_VERSION := '$$(KERNEL_VERSION).$$(KERNEL_PATCHLEVEL).$$(KERNEL_SUBLEVEL)$$(KERNEL_EXTRAVERSION)' >> $@
+	$(call git_cset_number,$(REPONAME)) >> $@
+	echo XS_RELEASE := '.xs$$(PLATFORM_VERSION).$$(CSET_NUMBER)' >> $@
+
+# RPM package Version and Release.
+#
+# This is a bit messy as if EXTRAVERSION is set it will start with a
+# dash so it needs to end up in PKG_RELEASE (but without the leading
+# dash).
+ifeq ($(KERNEL_EXTRAVERSION),)
+release_prefix := 1
+else
+release_prefix := $(KERNEL_EXTRAVERSION:-%=%)
+endif
+PKG_VERSION := $(KERNEL_VERSION).$(KERNEL_PATCHLEVEL).$(KERNEL_SUBLEVEL)
+PKG_RELEASE := $(release_prefix)$(XS_RELEASE)
+ARCHS := $(DOMAIN0_ARCH_OPTIMIZED)
+
+SOURCES = $(RPM_SOURCESDIR)/linux-$(LINUX_VERSION)$(XS_RELEASE).tar.bz2 \
+	  $(ARCHS:%=$(RPM_SOURCESDIR)/kernel-$(LINUX_VERSION)$(XS_RELEASE)-%.config) \
+          $(RPM_SPECSDIR)/kernel.spec
+
+SRPM = $(RPM_SRPMSDIR)/kernel-$(PKG_VERSION)-$(PKG_RELEASE).src.rpm
+
+.PHONY: build
+build: $(RPM_BUILT_COOKIE) $(FILES_COOKIE) $(MY_OUTPUT_DIR)/kernel.inc $(BRANDING) $(MY_SOURCES)/MANIFEST
+	@ :
+
+.PHONY: clean
+clean:
+	rm -f $(RPM_BUILT_COOKIE)
+	rm -f $(SOURCES)
+	rm -f $(SRPM)
+	-rm -f $(MY_OBJ_DIR)/version.inc
+	$(call component_clean,$(COMPONENT))
+
+$(RPM_SOURCESDIR)/linux-$(LINUX_VERSION)$(XS_RELEASE).tar.bz2: $(RPM_DIRECTORIES)
+	set -e -o pipefail; cd $(call git_loc,$(REPONAME)) && git archive --prefix=linux-$(LINUX_VERSION)$(XS_RELEASE)/ HEAD | bzip2 -c > $@.tmp
+	mv -f $@.tmp $@
+
+$(RPM_SOURCESDIR)/kernel-$(LINUX_VERSION)$(XS_RELEASE)-i686.config: ../buildconfigs/linux-defconfig_xen_x86_32 $(RPM_DIRECTORIES)
+	cp -f $< $@
+
+$(RPM_SOURCESDIR)/kernel-$(LINUX_VERSION)$(XS_RELEASE)-x86_64.config: ../buildconfigs/linux-defconfig_xen_x86_64 $(RPM_DIRECTORIES)
+	cp -f $< $@
+
+$(RPM_SPECSDIR)/kernel.spec: kernel.spec.in $(RPM_DIRECTORIES)
+	echo "Version: $(PKG_VERSION) Release: $(PKG_RELEASE)"; \
+	$(call brand,kernel.spec.in) | \
+	sed -e s\,@REPO_VERSION@,$(REPO_VERSION),g   \
+	    -e s\,@LINUX_VERSION@,$(LINUX_VERSION)$(XS_RELEASE),g \
+	    -e s\,@XS_RELEASE@,$(XS_RELEASE),g       \
+	    -e s\,@PKG_VERSION@,$(PKG_VERSION),g    \
+	    -e s\,@PKG_RELEASE@,$(PKG_RELEASE),g    \
+	> $@
+
+$(SRPM): $(SOURCES)
+	mkdir -p $(RPM_SRPMSDIR)
+	$(RPMBUILD) -bs $(RPM_SPECSDIR)/kernel.spec
+
+$(RPM_BUILT_COOKIE): $(RPM_DIRECTORIES) $(SRPM)
+	for arch in $(ARCHS); do \
+		$(RPMBUILD) --target $$arch --rebuild $(SRPM); \
+	done
+	@touch $@
+
+OUTPUT_RPM = kernel-$(PKG_VERSION)-$(PKG_RELEASE).$(DOMAIN0_ARCH_OPTIMIZED).rpm
+OUTPUT_DEBUG_RPM = kernel-debuginfo-$(PKG_VERSION)-$(PKG_RELEASE).$(DOMAIN0_ARCH_OPTIMIZED).rpm
+
+VMLINUX_PATH := /usr/lib/debug/lib/modules/$(LINUX_VERSION)$(XS_RELEASE)/vmlinux
+
+$(FILES_COOKIE): $(RPM_BUILT_COOKIE) $(MY_INSTALLER_FILES)/.dirstamp $(MY_MAIN_CDFILES)/.dirstamp
+	mkdir -p $(MY_INSTALLER_FILES)
+	rpm2cpio $(MY_OUTPUT_DIR)/RPMS/$(DOMAIN0_ARCH_OPTIMIZED)/$(OUTPUT_RPM) | ( cd $(MY_INSTALLER_FILES) ; cpio -id )
+
+	mkdir -p $(MY_MAIN_CDFILES)/boot/
+	mv $(MY_INSTALLER_FILES)/boot/vmlinuz-$(LINUX_VERSION)$(XS_RELEASE) $(MY_MAIN_CDFILES)/boot/vmlinuz
+
+#
+# The install-image component requires a gzipped, stripped vmlinux
+# file to build some of the more esoteric installers.
+#
+	rpm2cpio $(MY_OUTPUT_DIR)/RPMS/$(DOMAIN0_ARCH_OPTIMIZED)/$(OUTPUT_DEBUG_RPM) \
+		| cpio -i --to-stdout .$(VMLINUX_PATH) > $(MY_INSTALLER_FILES)/boot/vmlinux
+	objcopy --strip-debug --strip-unneeded $(MY_INSTALLER_FILES)/boot/vmlinux
+	gzip < $(MY_INSTALLER_FILES)/boot/vmlinux > $(MY_MAIN_CDFILES)/boot/vmlinux.gz
+
+	rm -rf $(MY_INSTALLER_FILES)/boot
+	touch $@
+
+$(MY_OUTPUT_DIR)/kernel.inc: $(MY_OUTPUT_DIR)/.dirstamp
+	( echo KERNEL_PKG_NAME := kernel ;\
+	  echo KERNEL_PKG_VERSION := $(LINUX_VERSION)$(XS_RELEASE) ;\
+	  echo KERNEL_PKG_ARCH := $(DOMAIN0_ARCH_OPTIMIZED) ;\
+	  echo KERNEL_PKG_FILE := RPMS/$(DOMAIN0_ARCH_OPTIMIZED)/$(OUTPUT_RPM) ;\
+	  echo KERNEL_VERSION := \$$\(KERNEL_PKG_VERSION\) ;\
+	) >$@
+
+$(BRANDING):
+	echo KERNEL_VERSION := $(LINUX_VERSION)$(XS_RELEASE) >$(BRANDING)
+
+$(MY_SOURCES)/MANIFEST: $(MY_SOURCES_DIRSTAMP)
+	echo "$(COMPONENT) gpl file $(SRPM)" >$@
+
+.PHONY: sources
+sources: $(MY_SOURCES)/MANIFEST
+	@ :
diff --git a/mk/kernel.spec.in b/mk/kernel.spec.in
new file mode 100644
index 0000000..27ec79b
--- /dev/null
+++ b/mk/kernel.spec.in
@@ -0,0 +1,272 @@
+# -*- rpm-spec -*-
+
+# The full kernel uname version
+%define uname         @LINUX_VERSION@
+
+%ifarch %{ix86}
+%define target       %{_target_cpu}
+%define arch	     i386
+%endif
+
+%ifarch x86_64
+%define target       %{_target_cpu}
+%define arch         %{_target_cpu}
+%endif
+
+%define COMMON_MAKEOPTS %{?_smp_mflags}
+%define DEFINE_MAKEOPTS \
+	ARCH=%{arch}; \
+	unset CROSS_COMPILE; \
+ 	case ${ARCH} in \
+	    *64) [ $(uname -m) = ${ARCH} ] || CROSS_COMPILE=x86_64-linux- ;; \
+	esac ; \
+	MAKEOPTS="%{COMMON_MAKEOPTS} ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE}"
+
+
+#
+# First the general kernel required versions as per
+# Documentation/Changes
+#
+#%define kernel_dot_org_conflicts  ppp < 2.4.0, pcmciautils < 004, isdn4k-utils < 3.1pre1, nfs-utils < 1.0.5, e2fsprogs < 1.41.4, util-linux < 2.10, jfsutils < 1.1.3, reiserfsprogs < 3.6.3, xfsprogs < 2.6.0, procps < 3.2.0, oprofile < 0.9
+%define kernel_dot_org_conflicts  ppp < 2.4.0, pcmciautils < 004, isdn4k-utils < 3.1pre1, nfs-utils < 1.0.5, util-linux < 2.10, jfsutils < 1.1.3, reiserfsprogs < 3.6.3, xfsprogs < 2.6.0, procps < 3.2.0, oprofile < 0.9
+
+#
+# Then a series of requirements that are distribution specific, either
+# because we add patches for something, or the older versions have
+# problems with the newer kernel or lack certain things that make
+# integration in the distro harder than needed.
+#
+%define package_conflicts  initscripts < 7.23, udev < 063-6, iptables < 1.3.2.1-1-1, ipw2200-firmware < 2.2
+
+#
+# Packages that need to be installed before the kernel is, because the %post
+# scripts use them.
+#
+%define kernel_prereq  fileutils, module-init-tools, initscripts >= 8.11.1-1, /sbin/new-kernel-pkg
+
+#
+# don't use RPM's internal dependency generator, instead
+# just use our magic one that finds the versions of kernel modules for
+# provides and don't do any requires
+# (we used to just turn off AutoReqProv on all packages)
+#
+%define _use_internal_dependency_generator 0
+%define __find_provides %{nil}
+%define __find_requires %{nil}
+
+Name: kernel
+Vendor: @COMPANY_NAME@
+Group: System Environment/Kernel
+License: GPLv2
+Version: @PKG_VERSION@
+Release: @PKG_RELEASE@
+ExclusiveArch: noarch i686 x86_64
+ExclusiveOS: Linux
+Summary: The Linux kernel built for Xen.
+BuildRequires(pre): module-init-tools, patch >= 2.5.4, bash >= 2.03, sh-utils, tar
+BuildRequires(pre): bzip2, findutils, gzip, m4, perl, make >= 3.78
+BuildRequires: gcc >= 2.96-98, binutils >= 2.12, redhat-rpm-config >= 8.0.32.1
+Provides: kernel = %{uname}
+Autoreqprov: no
+Requires(pre): %{kernel_prereq}
+Conflicts: %{kernel_dot_org_conflicts}
+Conflicts: %{package_conflicts}
+
+Source0: linux-%{uname}.tar.bz2
+Source1: kernel-%{uname}-i686.config
+
+BuildRoot: %{_tmppath}/kernel-%{version}-root
+
+%description
+This package provides the Linux kernel for privileged and unprivileged domains.
+
+@REPO_VERSION@
+
+%package headers
+Summary: Header files for the Linux kernel for use by glibc
+Group: Development/System
+Obsoletes: glibc-kernheaders
+Provides: kernel-headers = %{uname}
+Conflicts: kernel-headers < %{uname}
+
+%description headers
+This package provides the C header files that specify the interface
+between the Linux kernel and userspace libraries & programs. The
+header files define structures and constants that are needed when
+building most standard programs. They are also required when
+rebuilding the glibc package.
+
+@REPO_VERSION@
+
+
+%package devel
+Summary: Development package for building kernel modules to match the xen kernel.
+Group: System Environment/Kernel
+AutoReqProv: no
+Provides: kernel-devel = %{uname}
+
+%description devel
+This package provides kernel headers and makefiles sufficient to build modules
+against the %{uname} kernel.
+
+@REPO_VERSION@
+
+
+#%package doc
+#Summary: Various documentation bits found in the kernel source.
+#Group: Documentation
+#
+#%description doc
+#This package contains documentation files from the kernel
+#source. Various bits of information about the Linux kernel and the
+#device drivers shipped with it are documented in these files.
+#
+#You'll want to install this package if you need a reference to the
+#options that can be passed to Linux kernel modules at load time.
+
+%prep 
+
+%setup -q -n %{name}-%{version} -c
+cd linux-%{uname}
+%{DEFINE_MAKEOPTS}
+echo @XS_RELEASE@ > localversion
+make ${MAKEOPTS} mrproper
+cp -f %{_sourcedir}/kernel-%{uname}-%{target}.config .config
+
+%build
+
+cd linux-%{uname}
+%{DEFINE_MAKEOPTS}
+make ${MAKEOPTS} silentoldconfig
+if grep -q ^CONFIG_MODULES=y$ .config ; then
+    mkmodules=modules
+else
+    mkmodules=
+fi
+
+make ${MAKEOPTS} bzImage $mkmodules
+
+%install
+
+cd linux-%{uname}
+%{DEFINE_MAKEOPTS}
+# Install kernel
+install -d -m 755 $RPM_BUILD_ROOT/boot
+install -m 644 .config $RPM_BUILD_ROOT/boot/config-%{uname}
+install -m 644 System.map $RPM_BUILD_ROOT/boot/System.map-%{uname}
+install -m 644 arch/x86/boot/bzImage $RPM_BUILD_ROOT/boot/vmlinuz-%{uname}
+
+install -d -m 755 $RPM_BUILD_ROOT/lib/modules/%{uname}
+if grep -q ^CONFIG_MODULES=y$ .config ; then
+    # Install modules
+    make ${MAKEOPTS} INSTALL_MOD_PATH=$RPM_BUILD_ROOT modules_install
+    # mark modules executable so that strip-to-file can strip them
+    find $RPM_BUILD_ROOT/lib/modules/%{uname} -name "*.ko" -type f | xargs chmod u+x
+    
+    # Remove files created by depmod. These are recreated at install time.
+    rm -f $RPM_BUILD_ROOT/lib/modules/%{uname}/modules.*
+fi
+
+# Save debuginfo
+install -d -m 755 $RPM_BUILD_ROOT/usr/lib/debug/lib/modules/%{uname}
+install -m 644 vmlinux $RPM_BUILD_ROOT/usr/lib/debug/lib/modules/%{uname}
+
+# Install -headers files
+make ${MAKEOPTS} INSTALL_HDR_PATH=$RPM_BUILD_ROOT/usr headers_install
+
+# Install -devel files
+install -d -m 755 $RPM_BUILD_ROOT/usr/src/kernels/%{uname}-%{target}
+
+# Setup -devel links correctly
+SOURCE=/usr/src/kernels/%{uname}-%{target}
+rm -f $RPM_BUILD_ROOT/lib/modules/%{uname}/build
+rm -f $RPM_BUILD_ROOT/lib/modules/%{uname}/source
+ln -sf $SOURCE $RPM_BUILD_ROOT/lib/modules/%{uname}/source
+ln -sf $SOURCE $RPM_BUILD_ROOT/lib/modules/%{uname}/build
+
+install -d -m 755 $RPM_BUILD_ROOT${SOURCE}/arch/x86/kernel
+
+cp --parents `find  -type f -name "Makefile*" -o -name "Kconfig*"` $RPM_BUILD_ROOT${SOURCE}
+install -m 644 localversion $RPM_BUILD_ROOT${SOURCE}
+if [ -e Module.symvers ]; then
+    install -m 644 Module.symvers $RPM_BUILD_ROOT${SOURCE}
+fi
+# then drop all but the needed Makefiles/Kconfig files
+rm -rf $RPM_BUILD_ROOT${SOURCE}/Documentation
+rm -rf $RPM_BUILD_ROOT${SOURCE}/scripts
+rm -rf $RPM_BUILD_ROOT${SOURCE}/include
+install -m 644 arch/x86/kernel/asm-offsets.s $RPM_BUILD_ROOT${SOURCE}/arch/x86/kernel || :
+install -m 644 .config $RPM_BUILD_ROOT${SOURCE}
+install -m 644 .kernelrelease $RPM_BUILD_ROOT${SOURCE} || :
+cp -a scripts $RPM_BUILD_ROOT${SOURCE}
+cp -a arch/x86/scripts $RPM_BUILD_ROOT${SOURCE}/arch/x86 || :
+cp -a arch/x86/*lds $RPM_BUILD_ROOT${SOURCE}/arch/x86 || :
+rm -f $RPM_BUILD_ROOT${SOURCE}/scripts/*.o
+rm -f $RPM_BUILD_ROOT${SOURCE}/scripts/*/*.o
+
+install -d -m 755 $RPM_BUILD_ROOT${SOURCE}/arch/x86/include
+if [ -d arch/x86/include ] ; then
+    cp -a arch/x86/include/asm $RPM_BUILD_ROOT${SOURCE}/arch/x86/include
+    cp -a arch/x86/include/generated $RPM_BUILD_ROOT${SOURCE}/arch/x86/include
+fi
+
+install -d -m 755 $RPM_BUILD_ROOT${SOURCE}/include
+dirs=$(find include -mindepth 1 -maxdepth 1 -path include/asm-\* -prune -o -type d -print)
+cp -a ${dirs} include/asm-generic $RPM_BUILD_ROOT${SOURCE}/include
+if [ ! -d arch/x86/include ] ; then
+    cp -a `readlink include/asm` $RPM_BUILD_ROOT${SOURCE}/include
+fi
+
+# Make sure the Makefile and version.h have a matching timestamp so that
+# external modules can be built
+touch -r $RPM_BUILD_ROOT${SOURCE}/Makefile $RPM_BUILD_ROOT${SOURCE}/include/linux/version.h
+touch -r $RPM_BUILD_ROOT${SOURCE}/.config $RPM_BUILD_ROOT${SOURCE}/include/linux/autoconf.h
+
+# Firmware is provided by the linux-firmware package.
+rm -rf $RPM_BUILD_ROOT/lib/firmware
+
+find $RPM_BUILD_ROOT -name ..install.cmd -type f -delete
+
+%clean
+rm -rf $RPM_BUILD_ROOT
+
+%post
+exe=/sbin/new-kernel-pkg
+if [ -x /sbin/new-kernel-pkg.py ] ; then
+  exe=/sbin/new-kernel-pkg.py
+fi
+if grep -qs control_d /proc/xen/capabilities ; then
+  args=--multiboot=/boot/xen.gz
+fi
+
+$exe --install --package kernel-xen --mkinitrd --depmod --make-default $args %{uname}
+
+%preun
+exe=/sbin/new-kernel-pkg
+if [ -x /sbin/new-kernel-pkg.py ] ; then
+  exe=/sbin/new-kernel-pkg.py
+fi
+
+$exe --remove --package kernel-xen --rminitrd --rmmoddep %{uname}
+
+%files
+%defattr(-,root,root)
+/boot/vmlinuz-%{uname}
+/boot/System.map-%{uname}
+/boot/config-%{uname}
+%dir /lib/modules/%{uname}
+/lib/modules/%{uname}/kernel
+
+%files headers
+%defattr(-,root,root)
+/usr/include
+
+%files devel
+%defattr(-,root,root)
+/lib/modules/%{uname}/build
+/lib/modules/%{uname}/source
+%verify(not mtime) /usr/src/kernels/%{uname}-%{target}
+
+%changelog
+* Thu Mar 29 2012 Simon Rowe <simon.rowe@eu.citrix.com> - 3.3.0-rc3
+- Packaged for XenServer
